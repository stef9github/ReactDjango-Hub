# Deployment and Operations Guide

**Generated by**: Services Coordinator Agent  
**Date**: 2025-09-09  
**Purpose**: Complete deployment and monitoring setup for ReactDjango Hub microservices

---

## 🚀 **Quick Start - Full Stack Deployment**

### **Prerequisites**
- Docker 20.10+ and Docker Compose 2.0+
- 8GB+ RAM available for containers
- Ports available: 8000-8005, 8443, 8500, 9000, 9090, 3001, 16686

### **1. Start Everything with One Command**
```bash
# From services directory
cd services/

# Start full stack (API Gateway + All Services + Monitoring)
docker-compose -f docker-compose.full-stack.yml up -d

# Start monitoring stack separately (optional)
docker-compose -f monitoring/docker-compose.monitoring.yml up -d

# Check all services are healthy
docker-compose -f docker-compose.full-stack.yml ps
```

### **2. Access Points**
After deployment, access your services at:

| Component | URL | Credentials |
|-----------|-----|-------------|
| **API Gateway (Kong)** | http://localhost:8080 | - |
| **Kong Admin API** | http://localhost:8445 | - |
| **Django Backend** | http://localhost:8000 | - |
| **Identity Service** | http://localhost:8011/docs | - |
| **Grafana Dashboard** | http://localhost:3001 | admin/admin |
| **Prometheus** | http://localhost:9090 | - |
| **Jaeger UI** | http://localhost:16686 | - |
| **Consul UI** | http://localhost:8500 | - |
| **MinIO Console** | http://localhost:9001 | minioadmin/minioadmin |

---

## 📦 **Service Deployment Architecture**

### **Microservices Ports**
```yaml
Identity Service:         8001 (internal) / 8011 (external)
Communication Service:    8002
Content Service:          8003
Workflow Intelligence:    8005
Kong API Gateway:         8080 (proxy) / 8445 (admin)  # Port 8000 reserved for Django
```

### **Infrastructure Components**
```yaml
PostgreSQL:      5432 (per service)
Redis:           6379 (per service)
Kafka:           9092 / 29092
Zookeeper:       2181
Consul:          8500 / 8600
MinIO:           9000 / 9001
```

### **Monitoring Stack**
```yaml
Prometheus:      9090
Grafana:         3001
AlertManager:    9093
Loki:            3100
Jaeger:          16686
Node Exporter:   9100
cAdvisor:        8080
```

---

## 🔧 **Deployment Options**

### **Option 1: Development Mode (Hot Reload)**
```bash
# Uses local code with hot reload
docker-compose -f docker-compose.full-stack.yml up -d

# View logs for a specific service
docker-compose -f docker-compose.full-stack.yml logs -f identity-service

# Restart a single service
docker-compose -f docker-compose.full-stack.yml restart identity-service
```

### **Option 2: Production Mode (Optimized)**
```bash
# Build production images
docker-compose -f docker-compose.full-stack.yml build --no-cache

# Deploy with production settings
export DEBUG=false
export LOG_LEVEL=warning
docker-compose -f docker-compose.full-stack.yml up -d

# Scale services
docker-compose -f docker-compose.full-stack.yml up -d --scale identity-service=3
```

### **Option 3: Kubernetes Deployment**
```bash
# Apply Kong Gateway
kubectl apply -f kubernetes/kong/

# Deploy services
kubectl apply -f identity-service/kubernetes/
kubectl apply -f communication-service/kubernetes/
kubectl apply -f content-service/kubernetes/
kubectl apply -f workflow-intelligence-service/kubernetes/

# Deploy monitoring
kubectl apply -f monitoring/kubernetes/
```

---

## 📊 **Monitoring and Observability**

### **1. Metrics (Prometheus + Grafana)**

**Access Grafana**: http://localhost:3001 (admin/admin)

**Pre-configured Dashboards**:
- Service Health Overview
- API Performance Metrics
- Container Resource Usage
- Database Performance
- Redis Cache Metrics
- Message Queue Statistics

**Key Metrics to Monitor**:
```yaml
Service Uptime:        up{service="*"}
Request Rate:          rate(http_requests_total[5m])
Error Rate:            rate(http_requests_total{status=~"5.."}[5m])
P95 Latency:           histogram_quantile(0.95, http_request_duration_seconds_bucket)
CPU Usage:             rate(container_cpu_usage_seconds_total[5m])
Memory Usage:          container_memory_usage_bytes
Database Connections:  pg_stat_database_numbackends
Redis Memory:          redis_memory_used_bytes
```

### **2. Distributed Tracing (Jaeger)**

**Access Jaeger UI**: http://localhost:16686

**Trace Critical Flows**:
- User Authentication Flow
- Document Upload Pipeline
- Workflow Execution Chain
- Cross-Service API Calls

**Enable Tracing in Services**:
```python
# Add to each service
from opentelemetry import trace
from opentelemetry.exporter.jaeger import JaegerExporter

tracer = trace.get_tracer(__name__)

@app.middleware("http")
async def add_tracing(request: Request, call_next):
    with tracer.start_as_current_span(f"{request.method} {request.url.path}"):
        response = await call_next(request)
        return response
```

### **3. Centralized Logging (Loki + Promtail)**

**Query Logs in Grafana**:
```logql
# All service errors
{job="services"} |= "ERROR"

# Authentication failures
{service="identity-service"} |= "login failed"

# Slow queries
{service=~".*-service"} |= "slow query" | duration > 1000
```

### **4. Alerts**

**Critical Alerts Configured**:
- Service Down (>2 minutes)
- High Error Rate (>5%)
- High Memory Usage (>85%)
- Database Connection Pool Exhausted (>80%)
- Disk Space Low (<10%)
- Failed Login Spike (>10/sec)

**Alert Channels** (configure in AlertManager):
```yaml
# alertmanager/config.yml
receivers:
  - name: 'team-slack'
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#alerts'
  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_KEY'
```

---

## 🔐 **Security Configuration**

### **1. API Gateway Security**
```yaml
# Kong plugins enabled:
- JWT Authentication
- Rate Limiting
- CORS
- Request Size Limiting
- IP Restriction (production)
```

### **2. Service-to-Service Authentication**
All internal service calls use JWT tokens validated by Identity Service:
```python
# Automatic in all services
headers = {"Authorization": f"Bearer {service_token}"}
```

### **3. Network Isolation**
```yaml
# Services use internal network
networks:
  services_network:
    internal: true
    
# Only Gateway exposed externally
ports:
  - "8000:8000"  # Public API
```

---

## 🛠️ **Operations Playbook**

### **Health Checks**
```bash
# Check all services health
for port in 8001 8002 8003 8005; do
  echo "Service on port $port:"
  curl -s http://localhost:$port/health | jq .
done

# Check Kong Gateway
curl http://localhost:8001/status

# Check Consul service registry
curl http://localhost:8500/v1/health/service/identity-service
```

### **Common Operations**

**1. Update Service Configuration**:
```bash
# Edit service environment
vim .env

# Restart affected service
docker-compose -f docker-compose.full-stack.yml restart identity-service
```

**2. View Service Logs**:
```bash
# All logs
docker-compose -f docker-compose.full-stack.yml logs

# Specific service with follow
docker-compose -f docker-compose.full-stack.yml logs -f identity-service

# Last 100 lines
docker-compose -f docker-compose.full-stack.yml logs --tail=100 communication-service
```

**3. Database Operations**:
```bash
# Connect to service database
docker exec -it identity-service-db psql -U identity_user -d identity_service

# Backup database
docker exec identity-service-db pg_dump -U identity_user identity_service > backup.sql

# Run migrations
docker exec identity-service alembic upgrade head
```

**4. Scale Services**:
```bash
# Scale horizontally
docker-compose -f docker-compose.full-stack.yml up -d --scale identity-service=3

# Check scaled instances
docker-compose -f docker-compose.full-stack.yml ps identity-service
```

**5. Performance Profiling**:
```bash
# CPU/Memory stats
docker stats

# Service-specific profiling
docker exec identity-service py-spy top --pid 1
```

---

## 🚨 **Troubleshooting Guide**

### **Service Won't Start**
```bash
# Check logs
docker-compose -f docker-compose.full-stack.yml logs service-name

# Common issues:
- Port already in use: Change external port mapping
- Database connection failed: Check DB health, credentials
- Redis connection failed: Ensure Redis is running
- Identity service unreachable: Check service order, health
```

### **High Memory Usage**
```bash
# Check memory limits
docker-compose -f docker-compose.full-stack.yml exec service-name cat /proc/meminfo

# Add memory limits in docker-compose:
deploy:
  resources:
    limits:
      memory: 512M
```

### **Slow API Responses**
```bash
# Check service metrics
curl http://localhost:8001/metrics | grep http_request_duration

# Enable debug logging
docker-compose -f docker-compose.full-stack.yml exec service-name \
  sh -c "export LOG_LEVEL=debug && kill -HUP 1"
```

### **Database Issues**
```bash
# Check connections
docker exec identity-service-db psql -U identity_user -c \
  "SELECT count(*) FROM pg_stat_activity;"

# Kill idle connections
docker exec identity-service-db psql -U identity_user -c \
  "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = 'idle';"
```

---

## 📈 **Performance Tuning**

### **1. Service Optimization**
```yaml
# In docker-compose.yml
identity-service:
  environment:
    - WORKERS=4  # Increase workers
    - MAX_CONNECTIONS=100  # Database pool
    - REDIS_MAX_CONNECTIONS=50
    - REQUEST_TIMEOUT=30
```

### **2. Database Tuning**
```sql
-- PostgreSQL optimization
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET work_mem = '4MB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
```

### **3. Redis Optimization**
```redis
# Redis configuration
maxmemory 256mb
maxmemory-policy allkeys-lru
save ""  # Disable persistence for cache-only usage
```

### **4. Kong Gateway Optimization**
```yaml
# Kong performance settings
KONG_NGINX_WORKER_PROCESSES: auto
KONG_NGINX_WORKER_CONNECTIONS: 16384
KONG_UPSTREAM_KEEPALIVE_POOL_SIZE: 64
KONG_UPSTREAM_KEEPALIVE_MAX_REQUESTS: 1000
```

---

## 🔄 **Backup and Recovery**

### **Automated Backup Script**
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="./backups/$DATE"

mkdir -p $BACKUP_DIR

# Backup all databases
for service in identity communication content workflow; do
  docker exec ${service}-service-db pg_dump -U ${service}_user ${service}_service \
    > $BACKUP_DIR/${service}_db.sql
done

# Backup Redis data
docker exec identity-service-redis redis-cli SAVE
docker cp identity-service-redis:/data/dump.rdb $BACKUP_DIR/redis_identity.rdb

# Backup MinIO data
docker run --rm -v content_minio_data:/data -v $BACKUP_DIR:/backup \
  alpine tar czf /backup/minio_data.tar.gz /data

echo "Backup completed: $BACKUP_DIR"
```

### **Recovery Process**
```bash
# Restore database
docker exec -i identity-service-db psql -U identity_user identity_service < backup.sql

# Restore Redis
docker cp redis_backup.rdb identity-service-redis:/data/dump.rdb
docker restart identity-service-redis

# Restore MinIO
docker run --rm -v content_minio_data:/data -v ./backup:/backup \
  alpine tar xzf /backup/minio_data.tar.gz -C /
```

---

## 📋 **Deployment Checklist**

### **Pre-Deployment**
- [ ] All environment variables configured in `.env`
- [ ] Ports 8000-8005, 9000, 9090, 3001, 16686 available
- [ ] Docker and Docker Compose installed
- [ ] Minimum 8GB RAM available
- [ ] SSL certificates ready (production)

### **Deployment**
- [ ] Start infrastructure (databases, Redis, Kafka)
- [ ] Run database migrations
- [ ] Start microservices
- [ ] Configure Kong Gateway
- [ ] Start monitoring stack
- [ ] Verify health checks

### **Post-Deployment**
- [ ] Test authentication flow
- [ ] Verify inter-service communication
- [ ] Check monitoring dashboards
- [ ] Configure alerts
- [ ] Document service URLs
- [ ] Setup backup automation

---

## 🎯 **Next Steps**

1. **Production Hardening**:
   - Enable SSL/TLS everywhere
   - Implement secrets management (Vault)
   - Add Web Application Firewall (WAF)
   - Enable audit logging

2. **Scaling Strategy**:
   - Implement auto-scaling policies
   - Add read replicas for databases
   - Implement caching strategies
   - Use CDN for static content

3. **Disaster Recovery**:
   - Multi-region deployment
   - Automated failover
   - Regular disaster recovery drills
   - Data replication strategy

---

**🚀 Your microservices architecture is now fully deployed with comprehensive monitoring, security, and operational capabilities!**

---

**Document Maintainer**: Services Coordinator Agent  
**Last Updated**: 2025-09-09  
**Next Review**: After first production deployment