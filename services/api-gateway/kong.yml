# Kong API Gateway Configuration for Microservices
_format_version: "3.0"

services:
  # Auth Service
  - name: auth-service
    url: http://auth-service:8001
    protocol: http
    port: 8001
    retries: 3
    connect_timeout: 5000
    write_timeout: 60000
    read_timeout: 60000
    routes:
      - name: auth-routes
        paths:
          - /api/v1/auth
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - DELETE
              headers:
                - Authorization
                - Content-Type
              exposed_headers:
                - X-Auth-Token
              credentials: true
              max_age: 3600

  # Analytics Service
  - name: analytics-service
    url: http://analytics-service:8002
    protocol: http
    port: 8002
    retries: 3
    routes:
      - name: analytics-routes
        paths:
          - /api/v1/analytics
        strip_path: true
        plugins:
          - name: jwt
            config:
              secret_is_base64: false
              run_on_preflight: true
              claims_to_verify:
                - exp
          - name: request-transformer
            config:
              add:
                headers:
                  - X-Service-Name:analytics
                  - X-Request-ID:{{uuid}}

  # Billing Service
  - name: billing-service
    url: http://billing-service:8003
    protocol: http
    port: 8003
    retries: 3
    routes:
      - name: billing-routes
        paths:
          - /api/v1/billing
        strip_path: true
        plugins:
          - name: jwt
            config:
              secret_is_base64: false
          - name: acl
            config:
              allow:
                - admin
                - billing_manager
          - name: request-size-limiting
            config:
              allowed_payload_size: 10
              size_unit: megabytes

  # Core Service
  - name: core-service
    url: http://core-service:8004
    protocol: http
    port: 8004
    retries: 3
    routes:
      - name: core-routes
        paths:
          - /api/v1/core
        strip_path: true
        plugins:
          - name: jwt
            config:
              secret_is_base64: false

plugins:
  # Global plugins
  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
  
  - name: zipkin
    config:
      http_endpoint: http://zipkin:9411/api/v2/spans
      sample_ratio: 0.1
      include_credential: true
  
  - name: syslog
    config:
      successful_severity: info
      client_errors_severity: warning
      server_errors_severity: err

upstreams:
  # Load balancing for auth service
  - name: auth-service-upstream
    algorithm: round-robin
    healthchecks:
      active:
        type: http
        http_path: /health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
    targets:
      - target: auth-service-1:8001
        weight: 100
      - target: auth-service-2:8001
        weight: 100
      - target: auth-service-3:8001
        weight: 100