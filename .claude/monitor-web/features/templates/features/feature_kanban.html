{% extends 'base.html' %}
{% load static %}

{% block title %}Feature Kanban Board{% endblock %}

{% block extra_css %}
<style>
    .kanban-board {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 20px;
    }
    
    .kanban-column {
        flex: 0 0 300px;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        min-height: 500px;
    }
    
    .kanban-column-header {
        font-weight: bold;
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .kanban-card {
        background: white;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
    }
    
    .kanban-column.drag-over {
        background: #e9ecef;
        border: 2px dashed #6c757d;
    }
    
    .priority-LOW { border-left-color: #10B981; }
    .priority-MEDIUM { border-left-color: #F59E0B; }
    .priority-HIGH { border-left-color: #EF4444; }
    .priority-CRITICAL { border-left-color: #7C3AED; }
    
    .status-BACKLOG { background: linear-gradient(to right, #6B7280, #9CA3AF); }
    .status-PLANNED { background: linear-gradient(to right, #3B82F6, #60A5FA); }
    .status-IN_PROGRESS { background: linear-gradient(to right, #F59E0B, #FCD34D); }
    .status-TESTING { background: linear-gradient(to right, #8B5CF6, #A78BFA); }
    .status-REVIEW { background: linear-gradient(to right, #EC4899, #F472B6); }
    .status-DONE { background: linear-gradient(to right, #10B981, #34D399); }
    .status-BLOCKED { background: linear-gradient(to right, #EF4444, #F87171); }
    
    .kanban-column-header .badge {
        background: rgba(255,255,255,0.9);
        color: #333;
        font-weight: bold;
    }
    
    .feature-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
    }
    
    .agent-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: #e3f2fd;
        color: #1976d2;
        margin-right: 4px;
    }
    
    .progress-mini {
        width: 60px;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .progress-mini-bar {
        height: 100%;
        background: #4caf50;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Feature Kanban Board</h1>
        <div>
            <button class="btn btn-primary" onclick="location.href='{% url 'features:create' %}'">
                <i class="bi bi-plus-circle"></i> New Feature
            </button>
            <div class="btn-group ms-2">
                <a href="{% url 'features:list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-list"></i> List
                </a>
                <a href="{% url 'features:kanban' %}" class="btn btn-outline-secondary active">
                    <i class="bi bi-kanban"></i> Kanban
                </a>
                <a href="{% url 'features:roadmap' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-calendar3"></i> Roadmap
                </a>
                <a href="{% url 'features:statistics' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-graph-up"></i> Stats
                </a>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="categoryFilter" class="form-select form-select-sm" onchange="filterFeatures()">
                <option value="">All Categories</option>
                {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select id="priorityFilter" class="form-select form-select-sm" onchange="filterFeatures()">
                <option value="">All Priorities</option>
                <option value="CRITICAL">Critical</option>
                <option value="HIGH">High</option>
                <option value="MEDIUM">Medium</option>
                <option value="LOW">Low</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" id="searchFilter" class="form-control form-control-sm" 
                   placeholder="Search features..." onkeyup="filterFeatures()">
        </div>
        <div class="col-md-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> Reset Filters
            </button>
        </div>
    </div>
    
    <!-- Kanban Board -->
    <div class="kanban-board">
        {% for status_code, status_data in features_by_status.items %}
        <div class="kanban-column" data-status="{{ status_code }}">
            <div class="kanban-column-header status-{{ status_code }}">
                <span class="text-white">{{ status_data.name }}</span>
                <span class="badge">{{ status_data.features|length }}</span>
            </div>
            <div class="kanban-cards" data-status="{{ status_code }}">
                {% for feature in status_data.features %}
                <div class="kanban-card priority-{{ feature.priority }}" 
                     data-feature-id="{{ feature.id }}"
                     data-category="{{ feature.category.id|default:'' }}"
                     data-priority="{{ feature.priority }}"
                     data-title="{{ feature.title|lower }}">
                    <h6 class="mb-2">
                        <a href="{% url 'features:detail' feature.id %}" class="text-decoration-none text-dark">
                            {{ feature.title|truncatechars:50 }}
                        </a>
                    </h6>
                    
                    {% if feature.category %}
                    <span class="badge bg-secondary mb-2">{{ feature.category.name }}</span>
                    {% endif %}
                    
                    <p class="small text-muted mb-2">{{ feature.description|truncatewords:15 }}</p>
                    
                    <div class="feature-meta">
                        <div>
                            <span class="badge bg-{{ feature.get_priority_color|slice:'1:' }}">
                                {{ feature.get_priority_display }}
                            </span>
                            <span class="badge bg-light text-dark">
                                {{ feature.estimated_effort }} pts
                            </span>
                        </div>
                        <div class="progress-mini">
                            <div class="progress-mini-bar" style="width: {{ feature.progress_percentage }}%"></div>
                        </div>
                    </div>
                    
                    {% if feature.assigned_agents %}
                    <div class="mt-2">
                        {% for agent in feature.assigned_agents %}
                            <span class="agent-badge">{{ agent }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="mt-2 d-flex justify-content-between">
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ feature.created_at|date:"M d" }}
                        </small>
                        <div class="dropdown">
                            <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="{% url 'features:edit' feature.id %}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'features:plan' feature.id %}">
                                        <i class="bi bi-clipboard-check"></i> Plan
                                    </a>
                                </li>
                                {% if feature.status == 'PLANNED' %}
                                <li>
                                    <a class="dropdown-item" href="#" onclick="implementFeature({{ feature.id }})">
                                        <i class="bi bi-play-circle"></i> Implement
                                    </a>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'features:delete' feature.id %}">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
// Initialize drag and drop for each column
document.querySelectorAll('.kanban-cards').forEach(column => {
    Sortable.create(column, {
        group: 'kanban',
        animation: 150,
        ghostClass: 'dragging',
        dragClass: 'dragging',
        onEnd: function(evt) {
            const featureId = evt.item.dataset.featureId;
            const newStatus = evt.to.dataset.status;
            const oldStatus = evt.from.dataset.status;
            
            if (newStatus !== oldStatus) {
                updateFeatureStatus(featureId, newStatus);
            }
        }
    });
});

function updateFeatureStatus(featureId, newStatus) {
    fetch("{% url 'features:update_status' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            feature_id: featureId,
            new_status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update column counts
            updateColumnCounts();
            
            // Show toast notification
            showNotification('Feature status updated successfully', 'success');
        } else {
            // Move card back if update failed
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        location.reload();
    });
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column').forEach(column => {
        const status = column.dataset.status;
        const count = column.querySelectorAll('.kanban-card').length;
        const badge = column.querySelector('.badge');
        if (badge) {
            badge.textContent = count;
        }
    });
}

function filterFeatures() {
    const category = document.getElementById('categoryFilter').value;
    const priority = document.getElementById('priorityFilter').value;
    const search = document.getElementById('searchFilter').value.toLowerCase();
    
    document.querySelectorAll('.kanban-card').forEach(card => {
        let show = true;
        
        if (category && card.dataset.category !== category) {
            show = false;
        }
        
        if (priority && card.dataset.priority !== priority) {
            show = false;
        }
        
        if (search && !card.dataset.title.includes(search)) {
            show = false;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
    
    updateColumnCounts();
}

function resetFilters() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('searchFilter').value = '';
    filterFeatures();
}

function implementFeature(featureId) {
    if (!confirm('Start implementation of this feature?')) {
        return;
    }
    
    fetch(`/features/${featureId}/implement/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        }
    });
}

function showNotification(message, type) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }
    container.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>
{% endblock %}