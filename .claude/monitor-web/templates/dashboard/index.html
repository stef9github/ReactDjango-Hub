{% extends 'base.html' %}
{% load humanize %}

{% block title %}Dashboard - Agent Monitor{% endblock %}
{% block page_title %}System Dashboard{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="startAutoRefresh(5)">
        <i class="bi bi-play-circle"></i> Auto Refresh
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="stopAutoRefresh()">
        <i class="bi bi-stop-circle"></i> Stop
    </button>
</div>
{% endblock %}

{% block content %}
<!-- System Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">CPU Usage</h6>
                <h3 class="card-title">{{ cpu_usage|floatformat:1 }}%</h3>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar {% if cpu_usage > 80 %}bg-danger{% elif cpu_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                         style="width: {{ cpu_usage }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Memory Usage</h6>
                <h3 class="card-title">{{ memory_usage|floatformat:1 }}%</h3>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar {% if memory_usage > 80 %}bg-danger{% elif memory_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                         style="width: {{ memory_usage }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Disk Usage</h6>
                <h3 class="card-title">{{ disk_usage|floatformat:1 }}%</h3>
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar {% if disk_usage > 80 %}bg-danger{% elif disk_usage > 60 %}bg-warning{% else %}bg-info{% endif %}" 
                         style="width: {{ disk_usage }}%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Active Alerts</h6>
                <h3 class="card-title">{{ alert_count }}</h3>
                {% if alert_count > 0 %}
                    <span class="badge bg-danger">Requires Attention</span>
                {% else %}
                    <span class="badge bg-success">All Clear</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Agent & Task Status -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Agent Status</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h4>{{ active_agents }}</h4>
                        <small class="text-success">Active</small>
                    </div>
                    <div class="col">
                        <h4>{{ idle_agents }}</h4>
                        <small class="text-muted">Idle</small>
                    </div>
                    <div class="col">
                        <h4>{{ error_agents }}</h4>
                        <small class="text-danger">Error</small>
                    </div>
                    <div class="col">
                        <h4>{{ total_agents }}</h4>
                        <small>Total</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Task Queue</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h4>{{ pending_tasks }}</h4>
                        <small class="text-warning">Pending</small>
                    </div>
                    <div class="col">
                        <h4>{{ running_tasks }}</h4>
                        <small class="text-info">Running</small>
                    </div>
                    <div class="col">
                        <h4>{{ completed_tasks }}</h4>
                        <small class="text-success">Completed</small>
                    </div>
                    <div class="col">
                        <h4>{{ failed_tasks }}</h4>
                        <small class="text-danger">Failed</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">System Metrics History</h5>
            </div>
            <div class="card-body">
                <canvas id="metricsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Alerts</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% for alert in recent_alerts %}
                    <div class="alert alert-{{ alert.severity }} py-2 mb-2">
                        <small class="d-block"><strong>{{ alert.source }}</strong> - {{ alert.timestamp|naturaltime }}</small>
                        <small>{{ alert.message }}</small>
                    </div>
                {% empty %}
                    <p class="text-muted">No active alerts</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Agent List -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Agent Overview</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Status</th>
                                <th>Type</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>Tasks</th>
                                <th>Last Heartbeat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agent in agents %}
                                <tr>
                                    <td>
                                        <a href="{% url 'agents:detail' agent.pk %}">
                                            <strong>{{ agent.name }}</strong>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge status-{{ agent.status }}">{{ agent.get_status_display }}</span>
                                    </td>
                                    <td>{{ agent.type }}</td>
                                    <td>{{ agent.cpu_usage|floatformat:1 }}%</td>
                                    <td>{{ agent.memory_usage|floatformat:0 }} MB</td>
                                    <td>{{ agent.tasks_completed }}/{{ agent.tasks_failed }}</td>
                                    <td>{{ agent.last_heartbeat|naturaltime|default:"Never" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if agent.status == 'stopped' %}
                                                <form method="post" action="{% url 'agents:start' agent.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-success btn-sm">
                                                        <i class="bi bi-play"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <form method="post" action="{% url 'agents:stop' agent.pk %}" style="display: inline;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger btn-sm">
                                                        <i class="bi bi-stop"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                            <form method="post" action="{% url 'agents:restart' agent.pk %}" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-warning btn-sm">
                                                    <i class="bi bi-arrow-clockwise"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Logs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Logs</h5>
                <a href="{% url 'logs:list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Level</th>
                                <th>Source</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody">
                            {% for log in recent_logs %}
                                <tr class="log-entry log-{{ log.level }}">
                                    <td>{{ log.timestamp|date:"H:i:s" }}</td>
                                    <td><span class="badge bg-{{ log.level }}">{{ log.level|upper }}</span></td>
                                    <td>{{ log.source }}</td>
                                    <td>{{ log.message|truncatewords:20 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize metrics chart
let metricsChart;

function initMetricsChart() {
    const ctx = document.getElementById('metricsChart').getContext('2d');
    metricsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU Usage',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4
            }, {
                label: 'Memory Usage',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4
            }, {
                label: 'Active Agents',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
    
    updateMetricsChart();
}

function updateMetricsChart() {
    ajaxRequest('/api/metrics/history/?hours=1')
        .done(function(data) {
            metricsChart.data.labels = data.labels;
            metricsChart.data.datasets[0].data = data.datasets.cpu;
            metricsChart.data.datasets[1].data = data.datasets.memory;
            metricsChart.data.datasets[2].data = data.datasets.agents;
            metricsChart.update();
        });
}

// Update metrics every 10 seconds
setInterval(function() {
    ajaxRequest('/api/metrics/')
        .done(function(data) {
            // Update metric cards
            $('.metric-card').each(function() {
                const title = $(this).find('.card-subtitle').text();
                if (title.includes('CPU')) {
                    $(this).find('.card-title').text(data.system.cpu.toFixed(1) + '%');
                    updateProgressBar($(this), data.system.cpu);
                } else if (title.includes('Memory')) {
                    $(this).find('.card-title').text(data.system.memory.toFixed(1) + '%');
                    updateProgressBar($(this), data.system.memory);
                }
            });
            
            // Update counts
            $('#active-agents').text(data.agents.running);
            $('#idle-agents').text(data.agents.idle);
            $('#pending-tasks').text(data.tasks.pending);
            $('#running-tasks').text(data.tasks.running);
        });
    
    updateMetricsChart();
}, 10000);

function updateProgressBar(card, value) {
    const progressBar = card.find('.progress-bar');
    progressBar.css('width', value + '%');
    
    // Update color based on value
    progressBar.removeClass('bg-success bg-warning bg-danger');
    if (value > 80) {
        progressBar.addClass('bg-danger');
    } else if (value > 60) {
        progressBar.addClass('bg-warning');
    } else {
        progressBar.addClass('bg-success');
    }
}

// Stream logs
let lastLogId = 0;

function streamLogs() {
    ajaxRequest(`/logs/api/stream/?last_id=${lastLogId}`)
        .done(function(data) {
            if (data.logs.length > 0) {
                const tbody = $('#logTableBody');
                
                data.logs.forEach(function(log) {
                    const row = $('<tr>').addClass(`log-entry log-${log.level}`);
                    row.append($('<td>').text(new Date(log.timestamp).toLocaleTimeString()));
                    row.append($('<td>').html(`<span class="badge bg-${log.level}">${log.level.toUpperCase()}</span>`));
                    row.append($('<td>').text(log.source));
                    row.append($('<td>').text(log.message));
                    
                    tbody.prepend(row);
                    
                    // Keep only last 20 entries
                    if (tbody.children().length > 20) {
                        tbody.children().last().remove();
                    }
                });
                
                lastLogId = data.last_id;
            }
        });
}

// Initialize on page load
$(document).ready(function() {
    initMetricsChart();
    setInterval(streamLogs, 3000);
});
</script>
{% endblock %}